<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–°–£–ü-–¶–ò–í–ò–õ–ò–ó–ê–¶–ò–Ø ‚Äî —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–µ</title>
<style>
  :root{
    --bg1:#0b1220; --bg2:#0e1b33; --card:#131e35cc; --cardSolid:#141e33;
    --accent:#7cf0ff; --accent2:#8cff9a; --warn:#ff9b7c; --danger:#ff5370;
    --ok:#38d996; --muted:#9fb0d0; --line:#203253; --glow:0 0 18px rgba(124,240,255,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
    color:#e8f2ff; background: radial-gradient(1200px 700px at 70% -10%, #1a335c 0%, transparent 60%),
                          radial-gradient(900px 500px at -10% 30%, #152a4e 0%, transparent 60%),
                          linear-gradient(180deg,var(--bg1),var(--bg2));
    background-attachment: fixed;
  }
  header{
    display:flex; gap:16px; align-items:center; justify-content:space-between;
    padding:18px 18px 10px; border-bottom:1px solid var(--line);
    backdrop-filter:saturate(130%) blur(2px)
  }
  .title{display:flex;gap:12px;align-items:center}
  .logo{
    width:40px;height:40px;border-radius:12px;background:
      radial-gradient(circle at 40% 40%, #ffd36d 0 38%, #b65c00 40% 46%, transparent 47%),
      conic-gradient(from 0deg, #ffaa00, #ff7b00, #ff4d00, #ffaa00);
    box-shadow: var(--glow),0 4px 14px #0008;border:1px solid #ffb13f66
  }
  .title h1{margin:0;font-size:18px;letter-spacing:.3px}
  .sub{color:var(--muted);font-size:13px}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px;
    box-shadow:0 6px 24px #0007
  }
  h2{margin:0 0 10px;font-size:16px;letter-spacing:.2px}
  .stats{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
  .pill{
    background:linear-gradient(180deg,#0f1a31,#0a1426); border:1px solid var(--line);
    border-radius:12px;padding:10px;min-height:62px
  }
  .pill .cap{font-size:12px;color:var(--muted)}
  .pill .val{font-weight:700;font-size:18px;margin-top:2px}
  .row{display:flex; gap:8px; flex-wrap:wrap}
  button{
    cursor:pointer; border:1px solid var(--line); background:#0d1830; color:#eaf6ff;
    padding:10px 12px; border-radius:12px; font-weight:600; transition:.15s transform, .15s background, .15s opacity;
    box-shadow:0 2px 10px #0006
  }
  button:hover{transform:translateY(-1px)}
  button:disabled{opacity:.5; cursor:not-allowed; transform:none}
  .btn-acc{background:#0c2232;border-color:#1c405a}
  .btn-warn{background:#2c1620;border-color:#5a2942}
  .btn-ok{background:#11281f;border-color:#2f5a41}
  .cost{font-weight:600;color:var(--muted);font-size:12px;margin-left:6px}
  .bar{height:12px;background:#0a1326;border:1px solid var(--line); border-radius:999px; overflow:hidden}
  .bar > i{display:block;height:100%; background:linear-gradient(90deg, var(--accent), #58ffa3)}
  .bar.warn > i{background:linear-gradient(90deg, #ffb37b, #ff6b6b)}
  .bar.ok > i{background:linear-gradient(90deg, #61ffa9, #9cf6ff)}
  .kv{display:grid;grid-template-columns:1fr 1fr; gap:8px}
  .hint{color:var(--muted);font-size:12px}
  .list{display:grid; gap:8px}
  .upgrade{
    border:1px dashed #2a3c63; border-radius:12px;padding:10px; display:flex; gap:10px; align-items:center; justify-content:space-between
  }
  .upgrade.locked{opacity:.6;filter:saturate(.7)}
  .log{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:13px; white-space:pre-line; max-height:220px; overflow:auto; padding:10px; border:1px solid var(--line); border-radius:12px;background:#0a1426}
  .topbars{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin:12px 0 6px}
  .flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .right .card{height:100%}
  .footer{padding:10px 18px 30px; color:#8aa0c7; font-size:12px; text-align:center}
  .kbd{border:1px solid #2b3e65;border-radius:6px;padding:.5px 6px;background:#0b1730}
  /* modal */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(6,10,20,.65);backdrop-filter:blur(3px)}
  .modal .box{max-width:560px;background:var(--cardSolid);border:1px solid var(--line);border-radius:18px;padding:18px;box-shadow:0 12px 40px #000a}
  .box h3{margin:.2rem 0 .4rem}
  .box p{color:#cfe2ff}
  .split{display:flex; gap:10px; flex-wrap:wrap}
  .tag{padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#c6d6f5}
  .danger{color:#ff8e8e}
  .win{color:#9fffd1}
  a{color:#8bd0ff}
</style>
</head>
<body>
<header>
  <div class="title">
    <div class="logo" title="–¢—ë–ø–ª—ã–π –∫—Ä—É–≥ ‚Äî —ç—Ç–æ —Ç—ã, —Å—É–ø üç≤"></div>
    <div>
      <h1>–°–£–ü-–¶–ò–í–ò–õ–ò–ó–ê–¶–ò–Ø üç≤ ‚Äî —Ä–∞–∑–≤–µ–π —Ä–∞–∑—É–º –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ —Ç–µ–±—è –æ–±–Ω–∞—Ä—É–∂–∞—Ç</h1>
      <div class="sub">–¢—ã ‚Äî –∫–∞—Å—Ç—Ä—é–ª—è —Å—É–ø–∞ –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–µ. –†–∞—Å—Ç–∏ –º–∏–∫—Ä–æ–º–∏—Ä, –∏—Å—Å–ª–µ–¥—É–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –º–∞—Å–∫–∏—Ä—É–π –∑–∞–ø–∞—Ö, –ø–æ–∫–∞ –ª—é–¥–∏ –Ω–µ –Ω–∞—à–ª–∏ —Ç–µ–±—è –∏ –Ω–µ —Å–ª–∏–ª–∏ –≤ —É–Ω–∏—Ç–∞–∑.</div>
    </div>
  </div>
  <div class="flex">
    <button id="btn-pause" class="btn-acc">–ü–∞—É–∑–∞</button>
    <div class="flex">
      <span class="hint">–°–∫–æ—Ä–æ—Å—Ç—å:</span>
      <button class="btn-acc" data-speed="1">1√ó</button>
      <button class="btn-acc" data-speed="2">2√ó</button>
      <button class="btn-acc" data-speed="4">4√ó</button>
    </div>
    <button id="btn-reset" class="btn-warn" title="–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ –∏ –æ—á–∏—Å—Ç–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ">–°–±—Ä–æ—Å</button>
  </div>
</header>

<div class="wrap">
  <div class="stats">
    <div class="pill"><div class="cap">–ü–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞</div><div class="val" id="st-nutrients">0</div><div class="hint" id="rate-nutrients">+0/—Å</div></div>
    <div class="pill"><div class="cap">–ü–æ–ø—É–ª—è—Ü–∏—è –º–∏–∫—Ä–æ–±–æ–≤</div><div class="val" id="st-pop">0</div><div class="hint" id="rate-pop">—Ä–æ—Å—Ç 0/—Å</div></div>
    <div class="pill"><div class="cap">–ú—ã—Å–ª–∏—Ç–µ–ª–∏</div><div class="val" id="st-thinkers">0</div><div class="hint" id="rate-research">–Ω–∞—É–∫–∞ +0/—Å</div></div>
    <div class="pill"><div class="cap">–°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å</div><div class="val" id="st-stealth">0</div><div class="hint">–±–∏–æ–ø–ª—ë–Ω–∫–∏</div></div>
    <div class="pill"><div class="cap">–ó–∞–ø–∞—Ö</div><div class="val" id="st-smell">0%</div><div class="hint">—á–µ–º –≤—ã—à–µ ‚Äî —Ç–µ–º –æ–ø–∞—Å–Ω–µ–µ</div></div>
    <div class="pill"><div class="cap">–†–∏—Å–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è</div><div class="val" id="st-detect">0%</div><div class="hint">100% = —Å–ª–∏–≤ –≤ —É–Ω–∏—Ç–∞–∑</div></div>
  </div>

  <div class="topbars">
    <div>
      <div class="hint">–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–∏</div>
      <div class="bar ok"><i id="bar-research" style="width:0%"></i></div>
    </div>
    <div>
      <div class="hint">–ó–∞–ø–∞—Ö (–≤–ª–∏—è–µ—Ç –Ω–∞ —à–∞–Ω—Å –±—ã—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏)</div>
      <div class="bar warn"><i id="bar-smell" style="width:0%"></i></div>
    </div>
    <div>
      <div class="hint">–†–∏—Å–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è</div>
      <div class="bar warn"><i id="bar-detect" style="width:0%"></i></div>
    </div>
  </div>

  <div class="grid">
    <div class="left">
      <div class="card">
        <h2>–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –≤ –∫–∞—Å—Ç—Ä—é–ª–µ</h2>
        <div class="row">
          <button id="buy-microbe" class="btn-ok" title="–°–æ–∑–¥–∞—Ç—å –º–∏–∫—Ä–æ–±–æ–≤ ‚Äî –æ–Ω–∏ –ø–µ—Ä–µ—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Å—É–ø –≤ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞">
            –ó–∞—Å–µ—è—Ç—å –º–∏–∫—Ä–æ–±–æ–≤ +1 <span class="cost" id="c-microbe"></span>
          </button>
          <button id="buy-thinker" class="btn-acc" title="–≠–≤–æ–ª—é—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —á–∞—Å—Ç—å –ø–æ–ø—É–ª—è—Ü–∏–∏ –≤ –º—ã—Å–ª–∏—Ç–µ–ª–µ–π ‚Äî –æ–Ω–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –Ω–∞—É–∫—É">
            –≠–≤–æ–ª—é—Ü–∏—è –º—ã—Å–ª–∏—Ç–µ–ª—è +1 <span class="cost" id="c-thinker"></span>
          </button>
          <button id="build-biofilm" class="btn-acc" title="–ë–∏–æ–ø–ª—ë–Ω–∫–∞ –ø—Ä—è—á–µ—Ç –∑–∞–ø–∞—Ö –∏ —Å–Ω–∏–∂–∞–µ—Ç —Ä–æ—Å—Ç —Ä–∏—Å–∫–∞">
            –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –±–∏–æ–∫—É–ø–æ–ª +1 <span class="cost" id="c-biofilm"></span>
          </button>
          <button id="toggle-enzymes" class="btn-warn" title="–ö–æ—Ä–æ—Ç–∫–∏–π –±—É—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞, –Ω–æ –ø–∞—Ö–Ω–µ—Ç —Å–∏–ª—å–Ω–µ–µ">
            –≠–ù–ó–ò–ú–´: –≤—ã–∫–ª
          </button>
        </div>
        <div class="kv" style="margin-top:10px">
          <div class="pill">
            <div class="cap">–ë–æ–Ω—É—Å—ã</div>
            <div class="hint" id="bonuses">–Ω–µ—Ç</div>
          </div>
          <div class="pill">
            <div class="cap">–°–æ–±—ã—Ç–∏—è —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞</div>
            <div class="hint">–î–≤–µ—Ä—Ü–∞ –∏–Ω–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è‚Ä¶ –±—É–¥—å –≥–æ—Ç–æ–≤.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ –ø–æ–±–µ–¥–∞</h2>
        <div class="list" id="upgrades"></div>
        <div class="row" style="margin-top:8px">
          <button id="btn-win" class="btn-ok" disabled title="–î–æ—Å—Ç–∏–≥–Ω–∏ –Ω—É–∂–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞">–ü—Ä–æ–≤–æ–∑–≥–ª–∞—Å–∏—Ç—å –†–∞–∑—É–º –∏ —Å–ø–∞—Å—Ç–∏—Å—å</button>
        </div>
        <div class="hint" style="margin-top:6px">
          –ü–æ–±–µ–¥–∞: –Ω–∞–±–µ—Ä–∏ <b id="need-intel">200</b> –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É ¬´–ü—Ä–æ–≤–æ–∑–≥–ª–∞—Å–∏—Ç—å –†–∞–∑—É–º¬ª.
        </div>
      </div>

      <div class="card">
        <h2>–ñ—É—Ä–Ω–∞–ª</h2>
        <div id="log" class="log"></div>
      </div>
    </div>

    <div class="right">
      <div class="card">
        <h2>–ú–∏—Ä —Å—É–ø–∞ ‚Äî –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
        <div class="kv">
          <div>
            <div class="hint">–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç</div>
            <div class="bar ok"><i id="intel" style="width:0%"></i></div>
          </div>
          <div>
            <div class="hint">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ñ–æ–Ω (—Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫)</div>
            <div class="bar"><i id="heat" style="width:0%"></i></div>
          </div>
        </div>
        <div style="margin-top:10px" class="hint">
          –°–æ–≤–µ—Ç: —Å–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–≥–æ–Ω—è–π <b>–º–∏–∫—Ä–æ–±–æ–≤</b> –∏ <b>–ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞</b>, –∑–∞—Ç–µ–º –ø–µ—Ä–µ—Ö–æ–¥–∏ –≤ <b>–º—ã—Å–ª–∏—Ç–µ–ª–µ–π</b> –∏ —Å—Ç—Ä–æ–π <b>–±–∏–æ–∫—É–ø–æ–ª–∞</b>, —á—Ç–æ–±—ã –¥–µ—Ä–∂–∞—Ç—å –∑–∞–ø–∞—Ö –Ω–∏–∂–µ. –°–ª–µ–¥–∏ –∑–∞ –¥–≤–µ—Ä—Ü–µ–π —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞!
        </div>
        <hr style="border-color:#20325344;margin:14px 0">
        <div class="split">
          <span class="tag">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: <b id="saveLabel">–≤–∫–ª</b></span>
          <span class="tag">–ì–æ–¥ —Å—É–ø–∞: <b id="year">0</b></span>
          <span class="tag">–û—Ç–∫—Ä—ã—Ç–∏–π –¥–≤–µ—Ä–∏: <b id="doors">0</b></span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="footer">¬© –°—É–ø-—Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏—è. –°–¥–µ–ª–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é –∫ —Å—Ç—Ä–∞–Ω–Ω—ã–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –ø–æ–±–µ–¥—ã/–ø–æ—Ä–∞–∂–µ–Ω–∏—è -->
<div id="modal" class="modal" role="dialog" aria-modal="true">
  <div class="box">
    <h3 id="modal-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
    <p id="modal-text">–¢–µ–∫—Å—Ç</p>
    <div class="row">
      <button id="modal-close" class="btn-acc">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      <button id="modal-reset" class="btn-warn">–°—ã–≥—Ä–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
    </div>
  </div>
</div>

<script>
/* =============================
   –°–£–ü-–¶–ò–í–ò–õ–ò–ó–ê–¶–ò–Ø ‚Äî –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
   ============================= */
const UPGRADE_DEFS = [
  { id:'mask', name:'–ú–∞—Å–∫–∏—Ä—É—é—â–∏–µ –∞—Ä–æ–º–∞—Ç—ã', cost:50,
    desc:'–ó–∞–ø–∞—Ö –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 30% –º–µ–¥–ª–µ–Ω–Ω–µ–µ.',
    apply:s => s.mod.smellMul*=0.70 },
  { id:'cold', name:'–•–æ–ª–æ–¥–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è', cost:40,
    desc:'–ú–∏–∫—Ä–æ–±—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ª—É—á—à–µ –≤ —Ö–æ–ª–æ–¥–µ: +20% –∫ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–º –≤–µ—â–µ—Å—Ç–≤–∞–º.',
    apply:s => s.mod.nutrMul*=1.20 },
  { id:'door', name:'–®—ë–ø–æ—Ç –¥–≤–µ—Ä—Ü—ã', cost:60,
    desc:'–û—Ç–∫—Ä—ã—Ç–∏–µ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞ –ø–æ–≤—ã—à–∞–µ—Ç —Ä–∏—Å–∫ –≤ 2 —Ä–∞–∑–∞ –º–µ–Ω—å—à–µ.',
    apply:s => s.mod.doorFactor*=0.5 },
  { id:'bio2', name:'–£–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –±–∏–æ–∫—É–ø–æ–ª–∞', cost:80,
    desc:'–ö–∞–∂–¥—ã–π –±–∏–æ–∫—É–ø–æ–ª —Å–∏–ª—å–Ω–µ–µ: -20% –∫ –ø—Ä–∏—Ä–æ—Å—Ç—É –∑–∞–ø–∞—Ö–∞.',
    apply:s => s.mod.biofilmBonus+=0.20 },
  { id:'think', name:'–ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã–π —Ä–∞–∑—É–º', cost:100,
    desc:'–ú—ã—Å–ª–∏—Ç–µ–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –Ω–∞—É–∫—É –Ω–∞ 30% –±—ã—Å—Ç—Ä–µ–µ.',
    apply:s => s.mod.scienceMul*=1.30 },
  { id:'enzyme', name:'–ß–∏—Å—Ç—ã–µ —Ñ–µ—Ä–º–µ–Ω—Ç—ã', cost:75,
    desc:'–≠–Ω–∑–∏–º-—Ä–µ–∂–∏–º –¥–∞—ë—Ç +70% –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ (–≤–º–µ—Å—Ç–æ +50%) –∏ –º–µ–Ω—å—à–µ –ø–∞—Ö–Ω–µ—Ç.',
    apply:s => { s.mod.enzProd=1.70; s.mod.enzSmell=1.20 } },
  { id:'perfume', name:'–ü–∞—Ä—Ñ—é–º–µ—Ä–∏—è –∏–∑ —Ä–∞—Å—Å–æ–ª–∞', cost:120,
    desc:'–ó–∞–ø–∞—Ö —á–∞—Å—Ç–∏—á–Ω–æ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞.',
    apply:s => s.mod.smellToNutri=true },
  { id:'quantum', name:'–ö–≤–∞–Ω—Ç–æ–≤—ã–π –±—É–ª—å–æ–Ω', cost:140,
    desc:'–ù–µ–±–æ–ª—å—à–æ–π —à–∞–Ω—Å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–≤–µ—Ä–∏ —É–º–µ–Ω—å—à–∏—Ç—å —Ä–∏—Å–∫ –≤–º–µ—Å—Ç–æ —É–≤–µ–ª–∏—á–µ–Ω–∏—è.',
    apply:s => s.mod.quantumDoor=true },
];

const WIN_INTEL = 200;

const S = {
  time:0, year:0,
  nutrients: 15,
  microbes: 0,
  thinkers: 0,
  biofilms: 0,
  research: 0, // –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç
  smell: 0, // 0..100
  detect: 0, // 0..100
  heat: 25, // —É—Å–ª–æ–≤–Ω–∞—è —à–∫–∞–ª–∞ 0..100 (–≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–µ —Ö–æ–ª–æ–¥–Ω–æ -> –Ω–∏–∑–∫–æ)
  doors: 0,
  speed: 1,
  enzymes:false, enzymesTimer:0,
  upgrades:{},
  mod:{
    nutrMul:1, scienceMul:1, smellMul:1,
    doorFactor:1, biofilmBonus:0, enzProd:1.5, enzSmell:1.4,
    smellToNutri:false, quantumDoor:false
  }
};

// —Ü–µ–Ω—ã
const COST = {
  microbeBase: 5,
  thinkerNutri: 10,
  thinkerPop: 2,
  biofilmNutri: 20,
  biofilmPop: 5
};

function format(n){
  if (n>=1e6) return (n/1e6).toFixed(2)+'–º';
  if (n>=1e3) return (n/1e3).toFixed(2)+'–∫';
  return Math.floor(n).toString();
}
function clamp(n,min,max){ return Math.min(max,Math.max(min,n)); }

const ui = {
  n: id=>document.getElementById(id),
  btnsSpeed: Array.from(document.querySelectorAll('[data-speed]')),
  upgrades: document.getElementById('upgrades'),
  log: document.getElementById('log'),
  modal: document.getElementById('modal'),
  modalTitle: document.getElementById('modal-title'),
  modalText: document.getElementById('modal-text'),
  modalClose: document.getElementById('modal-close'),
  modalReset: document.getElementById('modal-reset')
};

function log(msg){
  const t = `[${(S.time/1000).toFixed(0)}—Å] ${msg}`;
  ui.log.textContent = t + '\n' + ui.log.textContent;
}

function microbeCost(){
  // –ø—Ä–æ—Å—Ç–∞—è –≤–æ–∑—Ä–∞—Å—Ç–∞—é—â–∞—è —Ü–µ–Ω–∞: base * (1.08 ^ microbes)
  return Math.ceil(COST.microbeBase * Math.pow(1.08, S.microbes));
}

function refreshUI(){
  ui.n('st-nutrients').textContent = format(S.nutrients);
  ui.n('st-pop').textContent = format(S.microbes);
  ui.n('st-thinkers').textContent = format(S.thinkers);
  ui.n('st-stealth').textContent = format(S.biofilms);
  ui.n('st-smell').textContent = Math.round(S.smell) + '%';
  ui.n('st-detect').textContent = Math.round(S.detect) + '%';
  ui.n('bar-smell').style.width = clamp(S.smell,0,100)+'%';
  ui.n('bar-detect').style.width = clamp(S.detect,0,100)+'%';
  const intelPct = clamp((S.research/WIN_INTEL)*100,0,100);
  ui.n('bar-research').style.width = intelPct+'%';
  ui.n('intel').style.width = intelPct+'%';
  ui.n('heat').style.width = clamp(S.heat,0,100)+'%';
  ui.n('year').textContent = S.year;
  ui.n('doors').textContent = S.doors;
  ui.n('need-intel').textContent = WIN_INTEL;

  // Rates (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ –≤ —Å–µ–∫—É–Ω–¥—É –ø—Ä–∏ —Ç–µ–∫—É—â–∏—Ö –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞—Ö)
  const prod = productionPerSec();
  ui.n('rate-nutrients').textContent = `+${prod.nutrients.toFixed(1)}/—Å`;
  ui.n('rate-pop').textContent = `—Ä–æ—Å—Ç ${(prod.popGrowth>=0?'+':'')}${prod.popGrowth.toFixed(2)}/—Å`;
  ui.n('rate-research').textContent = `+${prod.research.toFixed(2)}/—Å`;

  ui.n('c-microbe').textContent = `üíß ${microbeCost()}`;
  ui.n('c-thinker').textContent = `üíß ${COST.thinkerNutri} + üëæ ${COST.thinkerPop}`;
  ui.n('c-biofilm').textContent = `üíß ${COST.biofilmNutri} + üëæ ${COST.biofilmPop}`;
  ui.n('toggle-enzymes').textContent = `–≠–ù–ó–ò–ú–´: ${S.enzymes?'–≤–∫–ª':'–≤—ã–∫–ª'}${S.enzymes?` (${Math.ceil(S.enzymesTimer/1000)}—Å)`:''}`;

  // –ö–Ω–æ–ø–∫–∞ –ø–æ–±–µ–¥—ã
  ui.n('btn-win').disabled = S.research < WIN_INTEL || S.detect>=100;

  // –ë–æ–Ω—É—Å—ã
  const bs=[];
  if(S.enzymes) bs.push('—Ñ–µ—Ä–º–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã');
  if(S.upgrades.mask) bs.push('–º–∞—Å–∫–∏—Ä—É—é—â–∏–µ –∞—Ä–æ–º–∞—Ç—ã');
  if(S.upgrades.bio2) bs.push('—É—Å–∏–ª–µ–Ω–Ω—ã–µ –∫—É–ø–æ–ª–∞');
  if(S.upgrades.perfume) bs.push('–ø–∞—Ä—Ñ—é–º–µ—Ä–∏—è –∏–∑ —Ä–∞—Å—Å–æ–ª–∞');
  ui.n('bonuses').textContent = bs.length? bs.join(', '): '–Ω–µ—Ç';
}

function drawUpgrades(){
  ui.upgrades.innerHTML = '';
  for(const u of UPGRADE_DEFS){
    const have = !!S.upgrades[u.id];
    const can = S.research >= u.cost && !have;
    const el = document.createElement('div');
    el.className = 'upgrade' + (have?'':' locked');
    el.innerHTML = `
      <div>
        <div><b>${u.name}</b> ${have? '‚Äî –∏–∑—É—á–µ–Ω–æ ‚úÖ' : ''}</div>
        <div class="hint">${u.desc}</div>
      </div>
      <div>
        <button ${have?'disabled':''} data-up="${u.id}" class="btn-acc">${have?'–ö—É–ø–ª–µ–Ω–æ':'–ö—É–ø–∏—Ç—å'} ‚Äî üß™ ${u.cost}</button>
      </div>
    `;
    const btn = el.querySelector('button');
    if(!have){
      btn.disabled = !can;
      btn.title = can? '–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å' : '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞';
      btn.addEventListener('click',()=>{
        if(S.research>=u.cost && !S.upgrades[u.id]){
          S.research -= u.cost;
          S.upgrades[u.id] = true;
          u.apply(S);
          log(`–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ "${u.name}" –∑–∞–≤–µ—Ä—à–µ–Ω–æ.`);
          drawUpgrades();
          refreshUI();
          save();
        }
      })
    }
    ui.upgrades.appendChild(el);
  }
}

/* –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ/—Ñ–æ—Ä–º—É–ª—ã */
function productionPerSec(){
  // –±–∞–∑–æ–≤—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã
  const pop = S.microbes;
  const think = S.thinkers;
  const bio = S.biofilms;

  let nutrRate = pop * 0.6;         // –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞ –≤ —Å–µ–∫—É–Ω–¥—É
  let researchRate = think * 0.5;   // –Ω–∞—É–∫–∞
  let smellRate = (pop*0.02 + think*0.01); // –∑–∞–ø–∞—Ö

  // –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
  nutrRate *= S.mod.nutrMul;
  researchRate *= S.mod.scienceMul;

  // –±–∏–æ–∫—É–ø–æ–ª–∞ —É–º–µ–Ω—å—à–∞—é—Ç –∑–∞–ø–∞—Ö
  smellRate *= (1 - Math.min(0.85, bio * (0.07 + S.mod.biofilmBonus)));
  smellRate *= S.mod.smellMul;

  // —Ñ–µ—Ä–º–µ–Ω—Ç—ã
  if (S.enzymes){ nutrRate *= S.mod.enzProd; smellRate *= S.mod.enzSmell; }

  // –ª—ë–≥–∫–∏–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–æ—Å—Ç –ø–æ–ø—É–ª—è—Ü–∏–∏, –Ω–æ –ø–æ—Å–ª–µ 200 ‚Äî –Ω–∞—Å—ã—â–µ–Ω–∏–µ
  let popGrowth = Math.max(0, 0.02 * (1 - Math.min(1, pop/200)));

  return {nutrients:nutrRate, research:researchRate, smell:smellRate, popGrowth};
}

function tick(dt){
  if (S.detect>=100) return; // –∫–æ–Ω–µ—Ü –∏–≥—Ä—ã
  S.time += dt * S.speed;

  // –∫–∞–∂–¥—ã–µ "–≥–æ–¥—ã —Å—É–ø–∞"
  if (Math.floor(S.time/10000) > S.year){
    S.year++;
  }

  // –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è ‚Äî –æ—Ç–∫—Ä—ã—Ç–∏–µ –¥–≤–µ—Ä–∏
  maybeOpenDoor(dt);

  // —Ñ–µ—Ä–º–µ–Ω—Ç—ã —Ç–∞–π–º–µ—Ä
  if (S.enzymes){
    S.enzymesTimer -= dt*S.speed;
    if (S.enzymesTimer<=0){ S.enzymes=false; log('–≠–Ω–∑–∏–º—ã –≤—ã–¥–æ—Ö–ª–∏—Å—å.'); }
  }

  const prod = productionPerSec();
  S.nutrients += prod.nutrients * dt/1000;
  S.research  += prod.research  * dt/1000;
  S.smell     = clamp(S.smell + prod.smell * dt/1000, 0, 100);
  S.microbes  += prod.popGrowth * dt/1000;

  // —Ä–∏—Å–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –º–µ–¥–ª–µ–Ω–Ω–æ —Ä–∞—Å—Ç—ë—Ç –æ—Ç –∑–∞–ø–∞—Ö–∞
  S.detect = clamp(S.detect + (S.smell*0.012) * dt/1000, 0, 100);

  // –±–æ–Ω—É—Å "–ø–∞—Ä—Ñ—é–º–µ—Ä–∏—è": —á–∞—Å—Ç—å –∑–∞–ø–∞—Ö–∞ –≤ –µ–¥—É
  if (S.mod.smellToNutri && S.smell>5){
    const siphon = 0.0025 * S.smell * dt/1000;
    S.smell = Math.max(0, S.smell - siphon);
    S.nutrients += siphon*2;
  }

  // –ø–æ–±–µ–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –ø–æ—Ä–æ–≥—É –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞
  refreshUI();
}

/* –°–æ–±—ã—Ç–∏–µ –¥–≤–µ—Ä–∏ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞ */
let doorTimer = 0;
function maybeOpenDoor(dt){
  doorTimer -= dt*S.speed;
  if (doorTimer<=0){
    // –∫–∞–∂–¥–æ–µ "–æ–∫–Ω–æ" 18‚Äì34 —Å–µ–∫—É–Ω–¥
    doorTimer = (18000 + Math.random()*16000);
    // 45% —à–∞–Ω—Å, —á—Ç–æ –¥–≤–µ—Ä—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫—Ä–æ—é—Ç
    if (Math.random()<0.45){
      S.doors++;
      const base = 8 + S.smell*0.35 - S.biofilms*2.5;
      let delta = Math.max(2, base) * S.mod.doorFactor;

      if (S.mod.quantumDoor && Math.random()<0.20){
        // –∫–≤–∞–Ω—Ç–æ–≤—ã–π —Ñ–æ–∫—É—Å ‚Äî —Ä–∏—Å–∫ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è
        delta = -Math.min(6, base*0.6);
        log('–ö–≤–∞–Ω—Ç–æ–≤—ã–π –±—É–ª—å–æ–Ω —Å—ã–≥—Ä–∞–ª –Ω–∞ –Ω–∞—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ ‚Äî —Ä–∏—Å–∫ —Å–Ω–∏–∑–∏–ª—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–≤–µ—Ä–∏!');
      } else {
        log('–î–≤–µ—Ä—Ü–∞ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞ –æ—Ç–∫—Ä—ã–ª–∞—Å—å ‚Äî –∫—Ç–æ-—Ç–æ —á—Ç–æ-—Ç–æ –∏—â–µ—Ç‚Ä¶');
      }

      S.detect = clamp(S.detect + delta, 0, 100);

      // –∏–Ω–æ–≥–¥–∞ –µ—â—ë –∏ –ø–µ—Ä–µ–º–µ—à–∞–ª–∏ –∫–∞—Å—Ç—Ä—é–ª—é ‚Äî –Ω–µ–±–æ–ª—å—à–æ–π –≤—Å–ø–ª–µ—Å–∫ –∑–∞–ø–∞—Ö–∞
      if (Math.random()<0.35){
        S.smell = clamp(S.smell + 6, 0, 100);
        log('–ù–∞—Å —á—É—Ç—å-—á—É—Ç—å –ø–æ—Ç—Ä–µ–≤–æ–∂–∏–ª–∏ ‚Äî –∑–∞–ø–∞—Ö —É—Å–∏–ª–∏–ª—Å—è.');
      }
    }
  }
}

/* –ü–æ–∫—É–ø–∫–∏/–∫–Ω–æ–ø–∫–∏ */
function tryBuyMicrobe(){
  const c = microbeCost();
  if (S.nutrients>=c){
    S.nutrients -= c;
    S.microbes += 1;
    refreshUI(); save();
  }
}
function tryBuyThinker(){
  if (S.nutrients>=COST.thinkerNutri && S.microbes>=COST.thinkerPop){
    S.nutrients -= COST.thinkerNutri;
    S.microbes -= COST.thinkerPop;
    S.thinkers += 1;
    refreshUI(); save();
  }
}
function tryBuildBiofilm(){
  if (S.nutrients>=COST.biofilmNutri && S.microbes>=COST.biofilmPop){
    S.nutrients -= COST.biofilmNutri;
    S.microbes -= COST.biofilmPop;
    S.biofilms += 1;
    log('–í—ã—Ä–∞—Å—Ç–∏–ª–∏ –Ω–æ–≤—ã–π –±–∏–æ–∫—É–ø–æ–ª. –ó–∞–ø–∞—Ö –º–∞—Å–∫–∏—Ä—É–µ—Ç—Å—è –ª—É—á—à–µ.');
    refreshUI(); save();
  }
}
function toggleEnzymes(){
  if (!S.enzymes){
    if (S.nutrients>=5){
      S.nutrients -= 5;
      S.enzymes = true; S.enzymesTimer = 20000; // 20—Å
      log('–≠–Ω–∑–∏–º–Ω–∞—è –≤–µ—á–µ—Ä–∏–Ω–∫–∞! –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ —Ä–∞—Å—Ç—ë—Ç, –Ω–æ –∑–∞–ø–∞—Ö —Ç–æ–∂–µ.');
    }
  } else {
    S.enzymes = false; log('–≠–Ω–∑–∏–º—ã –≤—ã–∫–ª—é—á–µ–Ω—ã.');
  }
  refreshUI();
}

/* –ü–æ–±–µ–¥–∞/–ø–æ—Ä–∞–∂–µ–Ω–∏–µ */
function showModal(title, text){
  ui.modalTitle.textContent = title;
  ui.modalText.innerHTML = text;
  ui.modal.style.display = 'grid';
}
function hideModal(){ ui.modal.style.display='none'; }

function checkEnd(){
  if (S.detect>=100){
    showModal('–°–ª–∏—Ç—ã –≤ —É–Ω–∏—Ç–∞–∑ üíßüöΩ',
      `<span class="danger">–õ—é–¥–∏ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Å—É–ø –∏ –±–µ–∑ —Ä–∞–∑–¥—É–º–∏–π –∏–∑–±–∞–≤–∏–ª–∏—Å—å –æ—Ç –≤–∞—Å.</span><br><br>
       –í–∞—à –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –¥–æ—Å—Ç–∏–≥ <b>${Math.floor(S.research)}</b>. –í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –¥–µ—Ä–∂–∏—Ç–µ –∑–∞–ø–∞—Ö –Ω–∏–∂–µ –∏ —Å—Ç—Ä–æ–π—Ç–µ –±–æ–ª—å—à–µ –±–∏–æ–∫—É–ø–æ–ª–æ–≤.`);
    return true;
  }
  return false;
}

function tryWin(){
  if (S.research >= WIN_INTEL && S.detect<100){
    showModal('–ü–û–ë–ï–î–ê! –í—ã –æ–±—Ä–µ–ª–∏ –†–∞–∑—É–º üß†‚ú®',
      `<span class="win">–¶–∏–≤–∏–ª–∏–∑–∞—Ü–∏—è —Å—É–ø–∞ –æ—Ñ–æ—Ä–º–∏–ª–∞—Å—å! –í—ã –Ω–µ–∑–∞–º–µ—Ç–Ω–æ
       –ø–µ—Ä–µ–ø–∏—Å–∞–ª–∏ –Ω–∞–∫–ª–µ–π–∫—É ¬´–ù–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å¬ª –∏ –∫–æ–ª–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–∏ –±–ª–∏–∂–∞–π—à–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã.</span><br><br>
       <b>–ò—Ç–æ–≥–∏:</b> –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç ${Math.floor(S.research)}, –±–∏–æ–∫—É–ø–æ–ª–æ–≤ ${S.biofilms}, –¥–≤–µ—Ä—Ü–∞ –æ—Ç–∫—Ä—ã–≤–∞–ª–∞—Å—å ${S.doors} —Ä–∞–∑.`);
  }
}

/* –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ */
const SAVE_KEY='soup-civ-save';
function save(){ localStorage.setItem(SAVE_KEY, JSON.stringify(S)); ui.n('saveLabel').textContent='–≤–∫–ª'; }
function load(){
  const raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return;
  try{
    const obj = JSON.parse(raw);
    Object.assign(S, obj);
    // –ø—Ä–æ—Ç—è–Ω—É—Ç—å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã, –µ—Å–ª–∏ —Å—Ç–∞—Ä–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    S.mod = Object.assign({
      nutrMul:1, scienceMul:1, smellMul:1, doorFactor:1, biofilmBonus:0,
      enzProd:1.5, enzSmell:1.4, smellToNutri:false, quantumDoor:false
    }, S.mod || {});
  }catch(e){ console.warn('load failed', e); }
}

/* –ü—Ä–∏–≤—è–∑–∫–∞ UI */
document.getElementById('buy-microbe').addEventListener('click', tryBuyMicrobe);
document.getElementById('buy-thinker').addEventListener('click', tryBuyThinker);
document.getElementById('build-biofilm').addEventListener('click', tryBuildBiofilm);
document.getElementById('toggle-enzymes').addEventListener('click', toggleEnzymes);
document.getElementById('btn-win').addEventListener('click', tryWin);

document.getElementById('btn-pause').addEventListener('click', e=>{
  if (S.speed>0){ S._prevSpeed=S.speed; S.speed=0; e.target.textContent='–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å'; }
  else { S.speed= S._prevSpeed || 1; e.target.textContent='–ü–∞—É–∑–∞'; }
});

document.getElementById('btn-reset').addEventListener('click', ()=>{
  if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —É–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ?')){
    localStorage.removeItem(SAVE_KEY); location.reload();
  }
});

ui.modalClose.addEventListener('click', ()=>{ hideModal(); });
ui.modalReset.addEventListener('click', ()=>{
  localStorage.removeItem(SAVE_KEY); location.reload();
});

ui.btnsSpeed.forEach(b=>{
  b.addEventListener('click',()=>{
    S.speed = Number(b.dataset.speed)||1;
    document.getElementById('btn-pause').textContent='–ü–∞—É–∑–∞';
  })
});

/* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è */
load();
drawUpgrades();
refreshUI();
log('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–∞—Å—Ç—Ä—é–ª—é. –ü–∞—Ö–Ω–∏—Ç–µ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∏ —É—á–∏—Ç–µ—Å—å –±—ã—Å—Ç—Ä–µ–µ!');

/* –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª */
let last = performance.now();
function loop(now){
  const dt = now - last; last = now;
  if (S.speed>0){
    tick(dt);
    if (!checkEnd() && Math.floor(S.time)%5000===0){ save(); } // –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
